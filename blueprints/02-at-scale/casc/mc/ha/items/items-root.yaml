removeStrategy:
  rbac: SYNC
  items: NONE
items:
- kind: pipeline
  name: mockLoad
  description: 'It emulates workload in a controller see https://plugins.jenkins.io/mock-load-builder/'
  definition:
    cpsFlowDefinition:
      sandbox: true
      script: |-
        timeout(time: 1, unit: 'HOURS'){
            parallel([0, 1].collectEntries {b -> ["branch-$b", {
              podTemplate  (inheritFrom: 'maven-and-go-ondemand') {
                node(POD_LABEL) {
                    retry (3) {
                      stage('prep') {
                        sh 'curl https://ipinfo.io/'
                      }
                      stage('build') {
                        mockLoad 180
                      }
                      stage('publish') {
                        archiveArtifacts allowEmptyArchive: true, artifacts: 'mock-artifact-*.txt'
                        fingerprint 'mock-artifact-*.txt'
                        junit 'mock-junit.xml'
                      }
                    }
                }
              }
            }]})
        }
        build job: JOB_NAME, wait: false
- kind: pipeline
  name: build-agents-talks
  description: 'It validates archives/unarchive s3 artifacts from different pods agents in the same build.'
  definition:
    cpsFlowDefinition:
      sandbox: true
      script: |-
        timeout(time: 1, unit: 'HOURS'){
            podTemplate (inheritFrom: 'maven-and-go-ondemand') {
              retry (3) {
                  node(POD_LABEL) {
                    stage('beginning') {
                      sh 'sleep 30'
                      sh 'date > date.txt'
                      archiveArtifacts artifacts: 'date', fingerprint: true
                    }
                }
              }
            }
            checkpoint 'middle'
            podTemplate (inheritFrom: 'maven-spot') {
              retry (3) {
                  node(POD_LABEL) {
                    stage('end') {
                      dir ('unarchive'){
                        unarchive mapping: [date: 'date.txt']
                        sh 'cat date.txt'
                        sh 'sleep 1h'
                      }
                    }
                  }
              }
            }
        }
- kind: pipeline
  name: windows-builds-nodes
  concurrentBuild: false
  description: 'It validates the windows nodes builds.'
  definition:
    cpsFlowDefinition:
      sandbox: true
      script: |
        pipeline {
          agent {
            kubernetes {
              yaml '''
                apiVersion: v1
                kind: Pod
                spec:
                  containers:
                  - name: jnlp
                    image: jenkins/inbound-agent:windowsservercore-1809
                  - name: shell
                    image: mcr.microsoft.com/powershell:preview-windowsservercore-1809
                    command:
                    - powershell
                    args:
                    - Start-Sleep
                    - 999999
                  nodeSelector:
                    kubernetes.io/os: windows
                '''
              retries 2
            }
          }
          stages {
            stage('Test') {
              steps {
                container('shell') {
                    powershell 'Get-ChildItem Env: | Sort Name'
                }
              }
            }
          }
        }
